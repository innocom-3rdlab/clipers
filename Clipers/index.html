<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeç››ã‚Šä¸ŠãŒã‚Šåˆ†æãƒ„ãƒ¼ãƒ« (Gemini Enhanced) - ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            display: inline-block;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .analysis-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .option-card.selected {
            border-color: #43e97b;
            background: #f0fff8;
        }

        .option-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .option-card p {
            color: #666;
            font-size: 0.9em;
        }

        .api-key-section {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .api-key-section h4 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .api-key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            font-family: monospace;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-key-status {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #28a745;
        }

        /* åˆ†æã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .analysis-steps {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .analysis-step {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #e9ecef;
        }
        
        .analysis-step.processing {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .analysis-step.completed {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .analysis-step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step-title {
            font-weight: bold;
            flex: 1;
        }
        
        .step-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .step-description {
            color: #666;
            font-size: 14px;
            margin-left: 34px;
        }

        .status-error {
            background: #dc3545;
        }

        .status-warning {
            background: #ffc107;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .result-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .gemini-result-card {
            border-left: 5px solid #43e97b;
        }

        .gemini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .gemini-item {
            background: #f0fff8;
            padding: 20px;
            border-radius: 10px;
        }

        .gemini-item h4 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .gemini-item .score {
            font-size: 2em;
            font-weight: bold;
            color: #20c997;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .hot-timestamps {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .hot-timestamps h4 {
            color: #721c24;
            margin-bottom: 15px;
        }

        .timestamp-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #dc3545;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .vvp-weight-section {
            margin: 30px 0 10px 0;
            background: #f4f8ff;
            border-radius: 10px;
            padding: 20px;
        }

        .vvp-weight-section h3 {
            margin-bottom: 10px;
        }

        .vvp-weight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .vvp-weight-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .vvp-weight-item label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .vvp-weight-item input[type="range"] {
            width: 100%;
        }

        .vvp-weight-total {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœ¨ YouTubeç››ã‚Šä¸ŠãŒã‚Šåˆ†æãƒ„ãƒ¼ãƒ«</h1>
            <p>Gemini AIã«ã‚ˆã‚‹è³ªçš„åˆ†æã§ã€å‹•ç”»ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã™</p>
            <div class="version-badge">v2.2.0-standalone</div>
        </div>

        <div class="main-content">
            <div class="info-box">
                <h4>ğŸš€ ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆã«ã¤ã„ã¦</h4>
                <p>ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ä¸è¦ã§å‹•ä½œã—ã¾ã™ã€‚APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦YouTubeå‹•ç”»URLã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§åˆ†æã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
            </div>

            <div class="input-section">
                <h2>åˆ†æã—ãŸã„YouTubeå‹•ç”»ã®URLã‚’å…¥åŠ›</h2>
                <div class="input-group">
                    <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." />
                </div>
                
                <div class="analysis-options">
                    <div class="option-card selected" onclick="selectAnalysis('gemini')">
                        <h3>âœ¨ Gemini AI æ‹¡å¼µåˆ†æ (æ¨å¥¨)</h3>
                        <p>AIã«ã‚ˆã‚‹è³ªçš„åˆ†æã¨æˆ¦ç•¥çš„ææ¡ˆ</p>
                    </div>
                    <div class="option-card" onclick="selectAnalysis('engagement')">
                        <h3>ğŸ“Š ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ</h3>
                        <p>YouTube Data APIã«ã‚ˆã‚‹å®šé‡åˆ†æ</p>
                    </div>
                    <div class="option-card" onclick="selectAnalysis('basic')">
                        <h3>ğŸ” åŸºæœ¬æƒ…å ±å–å¾—</h3>
                        <p>å‹•ç”»ã®åŸºæœ¬æƒ…å ±ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="analyzeVideo()">åˆ†æé–‹å§‹</button>
                </div>
            </div>

            <div class="api-key-section">
                <h4>ğŸ”‘ API Keyè¨­å®š</h4>
                <p>åˆ†æã«ã¯YouTube Data API v3ã¨Gemini APIã®ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</p>
                <input type="password" id="youtubeApiKeyInput" class="api-key-input" placeholder="ã“ã“ã«YouTube APIã‚­ãƒ¼ã‚’å…¥åŠ›">
                <input type="password" id="geminiApiKeyInput" class="api-key-input" placeholder="ã“ã“ã«Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
                <button class="btn btn-success" onclick="saveApiKeys()">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="testApiKeys()" style="margin-left: 10px;">APIã‚­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ</button>
                <p style="font-size: 0.8em; margin-top: 10px;">APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="vvp-weight-section" style="margin: 30px 0 10px 0; background: #f4f8ff; border-radius: 10px; padding: 20px;">
                <h3 style="margin-bottom: 10px;">âš–ï¸ VVPã‚¹ã‚³ã‚¢é‡ã¿èª¿æ•´</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <div>
                        <label>ç‰©èªæ§‹é€  <span id="weight-narrative-val">18</span>%</label>
                        <input type="range" min="5" max="30" value="18" id="weight-narrative" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>ãƒ•ãƒƒã‚¯åŠ¹æœ <span id="weight-hook-val">16</span>%</label>
                        <input type="range" min="5" max="30" value="16" id="weight-hook" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>æ„Ÿæƒ…çš„ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ <span id="weight-engagement-val">16</span>%</label>
                        <input type="range" min="5" max="30" value="16" id="weight-engagement" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>æŠ€è¡“çš„å“è³ª <span id="weight-tech-val">10</span>%</label>
                        <input type="range" min="5" max="20" value="10" id="weight-tech" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>è©±é¡Œæ€§ <span id="weight-topic-val">12</span>%</label>
                        <input type="range" min="5" max="20" value="12" id="weight-topic" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>ã‚³ãƒ¡ãƒ³ãƒˆå¤šæ§˜æ€§ <span id="weight-diversity-val">10</span>%</label>
                        <input type="range" min="5" max="20" value="10" id="weight-diversity" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>å±æ€§é©åˆåº¦ <span id="weight-viewerfit-val">10</span>%</label>
                        <input type="range" min="5" max="20" value="10" id="weight-viewerfit" oninput="updateVvpWeights()">
                    </div>
                    <div>
                        <label>æº€è¶³åº¦ <span id="weight-satisfaction-val">8</span>%</label>
                        <input type="range" min="5" max="20" value="8" id="weight-satisfaction" oninput="updateVvpWeights()">
                    </div>
                </div>
                <div style="font-size:0.9em; color:#666; margin-top:8px;">åˆè¨ˆ100%ã«ãªã‚‹ã‚ˆã†è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™</div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>å‹•ç”»ã‚’åˆ†æä¸­ã§ã™... GeminiãŒæ€è€ƒã‚’å·¡ã‚‰ã›ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
            </div>

            <!-- åˆ†æã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="analysis-steps" id="analysisSteps" style="display: none;">
                <h3>ğŸ” AIåˆ†æãƒ—ãƒ­ã‚»ã‚¹</h3>
                <div class="steps-container" id="stepsContainer">
                    <!-- ã‚¹ãƒ†ãƒƒãƒ—ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>

            <div class="results" id="results">
                <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        let selectedAnalysis = 'gemini';

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            const youtubeKey = localStorage.getItem('youtube_api_key') || '';
            const geminiKey = localStorage.getItem('gemini_api_key') || '';
            document.getElementById('youtubeApiKeyInput').value = youtubeKey;
            document.getElementById('geminiApiKeyInput').value = geminiKey;
            // åˆæœŸé¸æŠ
            document.querySelector('.option-card').classList.add('selected');
        });

        function selectAnalysis(type) {
            selectedAnalysis = type;
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function saveApiKeys() {
            const youtubeApiKey = document.getElementById('youtubeApiKeyInput').value.trim();
            const geminiApiKey = document.getElementById('geminiApiKeyInput').value.trim();
            localStorage.setItem('youtube_api_key', youtubeApiKey);
            localStorage.setItem('gemini_api_key', geminiApiKey);
            // å…¥åŠ›æ¬„ã«å³æ™‚åæ˜ 
            document.getElementById('youtubeApiKeyInput').value = youtubeApiKey;
            document.getElementById('geminiApiKeyInput').value = geminiApiKey;
            alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        // APIã‚­ãƒ¼ã®ãƒ†ã‚¹ãƒˆé–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function testApiKeys() {
            const youtubeApiKey = document.getElementById('youtubeApiKeyInput').value.trim();
            const geminiApiKey = document.getElementById('geminiApiKeyInput').value.trim();
            let results = '<div class="result-card"><h3>ğŸ” APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆçµæœ</h3>';
            // YouTube APIãƒ†ã‚¹ãƒˆ
            if (youtubeApiKey) {
                try {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&maxResults=1&key=${youtubeApiKey}`);
                    if (response.ok) {
                        results += '<p style="color: green;">âœ… YouTube API: æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™</p>';
                        localStorage.setItem('youtube_api_key', youtubeApiKey);
                    } else {
                        const errorData = await response.json();
                        results += `<p style="color: red;">âŒ YouTube API: ã‚¨ãƒ©ãƒ¼ (${response.status}) - ${errorData.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</p>`;
                    }
                } catch (error) {
                    results += `<p style="color: red;">âŒ YouTube API: æ¥ç¶šã‚¨ãƒ©ãƒ¼ - ${error.message}</p>`;
                }
            } else {
                results += '<p style="color: orange;">âš ï¸ YouTube API: ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            }
            // Gemini APIãƒ†ã‚¹ãƒˆ
            if (geminiApiKey) {
                const geminiEndpoints = [
                    'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent',
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
                    'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent'
                ];
                let geminiSuccess = false;
                let geminiErrors = [];
                for (let i = 0; i < geminiEndpoints.length; i++) {
                    try {
                        if (i > 0) await new Promise(resolve => setTimeout(resolve, 1000));
                        const response = await fetch(`${geminiEndpoints[i]}?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: "ã“ã‚“ã«ã¡ã¯ã€‚ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚" }] }]
                            })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            results += `<p style="color: green;">âœ… Gemini API (ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ${i + 1}): æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™</p>`;
                            localStorage.setItem('gemini_api_key', geminiApiKey);
                            geminiSuccess = true;
                            break;
                        } else {
                            const errorData = await response.json();
                            const errorMessage = errorData.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
                            if (response.status === 429) {
                                geminiErrors.push(`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ${i + 1}: ã‚¯ã‚©ãƒ¼ã‚¿è¶…é - ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„`);
                            } else {
                                geminiErrors.push(`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ${i + 1}: ${response.status} - ${errorMessage}`);
                            }
                        }
                    } catch (error) {
                        geminiErrors.push(`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ${i + 1}: æ¥ç¶šã‚¨ãƒ©ãƒ¼ - ${error.message}`);
                    }
                }
                if (!geminiSuccess) {
                    results += `<p style="color: red;">âŒ Gemini API: ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚¨ãƒ©ãƒ¼</p>`;
                    results += `<p style="color: orange;">è©³ç´°: ${geminiErrors.join(', ')}</p>`;
                    results += `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <h4>ğŸ’¡ å¯¾å‡¦æ³•:</h4>
                        <ul>
                            <li><strong>ã‚¯ã‚©ãƒ¼ã‚¿è¶…éã®å ´åˆ:</strong> Google AI Studioã§ã‚¯ã‚©ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</li>
                            <li><strong>APIã‚­ãƒ¼ã®ç¢ºèª:</strong> æ­£ã—ã„APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                            <li><strong>å¾…æ©Ÿæ™‚é–“:</strong> ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ</li>
                            <li><strong>ä»£æ›¿æ‰‹æ®µ:</strong> ä¸€æ™‚çš„ã«YouTubeåˆ†æã®ã¿ã‚’ä½¿ç”¨</li>
                        </ul>
                    </div>`;
                }
            } else {
                results += '<p style="color: orange;">âš ï¸ Gemini API: ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            }
            results += '</div>';
            document.getElementById('results').innerHTML = results;
            document.getElementById('results').style.display = 'block';
        }

        // YouTubeå‹•ç”»IDã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // åˆ†æã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºé–¢æ•°
        function displayAnalysisSteps(steps) {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = '';
            
            steps.forEach(step => {
                const stepElement = document.createElement('div');
                stepElement.className = `analysis-step ${step.status}`;
                stepElement.innerHTML = `
                    <div class="step-header">
                        <span class="step-number">${step.step}</span>
                        <span class="step-title">${step.title}</span>
                        <span class="step-status ${step.status}">${getStatusText(step.status)}</span>
                    </div>
                    <div class="step-description">${step.description}</div>
                `;
                container.appendChild(stepElement);
            });
            
            document.getElementById('analysisSteps').style.display = 'block';
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'processing': return 'ğŸ”„ å‡¦ç†ä¸­';
                case 'completed': return 'âœ… å®Œäº†';
                case 'error': return 'âŒ ã‚¨ãƒ©ãƒ¼';
                default: return 'â³ å¾…æ©Ÿä¸­';
            }
        }

        // å‹•ç”»ã®é•·ã•ã‚’åˆ†ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function parseDuration(duration) {
            if (!duration || duration === 'PT0S') return 0;
            
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return 0;
            
            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            const seconds = parseInt(match[3]) || 0;
            
            return hours * 60 + minutes + seconds / 60;
        }

        // è©±é¡Œæ€§ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°
        function calculateTopicScore(videoInfo, comments) {
            const trendingKeywords = [
                'æœ€æ–°', 'æ–°ä½œ', 'åˆå…¬é–‹', 'ç·Šæ€¥', 'é€Ÿå ±', 'è©±é¡Œ', 'ãƒˆãƒ¬ãƒ³ãƒ‰', 'æµè¡Œ', 'äººæ°—',
                '2024', '2025', 'ä»Šå¹´', 'ä»Šæœˆ', 'ä»Šé€±', 'æ˜¨æ—¥', 'ä»Šæ—¥',
                'AI', 'ChatGPT', 'VR', 'AR', 'ãƒ¡ã‚¿ãƒãƒ¼ã‚¹', 'NFT', 'ä»®æƒ³é€šè²¨',
                'ã‚³ãƒ­ãƒŠ', 'ãƒ¯ã‚¯ãƒãƒ³', 'æ„ŸæŸ“ç—‡', 'ç½å®³', 'åœ°éœ‡', 'å°é¢¨',
                'é¸æŒ™', 'æ”¿æ²»', 'çµŒæ¸ˆ', 'æ ªä¾¡', 'ç‚ºæ›¿', 'é‡‘åˆ©'
            ];
            
            let topicScore = 5; // åŸºæœ¬ã‚¹ã‚³ã‚¢
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜æ–‡ã®è©±é¡Œæ€§ãƒã‚§ãƒƒã‚¯
            const titleAndDesc = (videoInfo.title + ' ' + (videoInfo.description || '')).toLowerCase();
            trendingKeywords.forEach(keyword => {
                if (titleAndDesc.includes(keyword.toLowerCase())) {
                    topicScore += 0.5;
                }
            });
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã®è©±é¡Œæ€§ãƒã‚§ãƒƒã‚¯
            const commentText = comments.join(' ').toLowerCase();
            trendingKeywords.forEach(keyword => {
                if (commentText.includes(keyword.toLowerCase())) {
                    topicScore += 0.2;
                }
            });
            
            // è¦–è´å›æ•°ã«ã‚ˆã‚‹è©±é¡Œæ€§è£œæ­£
            if (videoInfo.viewCount > 1000000) topicScore += 1;
            else if (videoInfo.viewCount > 100000) topicScore += 0.5;
            
            return Math.min(10, Math.max(1, topicScore));
        }

        // è¦–è´é›†ä¸­åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°
        function calculateViewingConcentrationScore(videoInfo, comments, engagementScore) {
            let concentrationScore = 5; // åŸºæœ¬ã‚¹ã‚³ã‚¢
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå¯†åº¦ã«ã‚ˆã‚‹é›†ä¸­åº¦æ¨å®š
            const commentDensity = comments.length / Math.max(1, parseDuration(videoInfo.duration));
            if (commentDensity > 10) concentrationScore += 2;
            else if (commentDensity > 5) concentrationScore += 1;
            
            // ã„ã„ã­ç‡ã«ã‚ˆã‚‹é›†ä¸­åº¦æ¨å®š
            const likeRate = videoInfo.viewCount > 0 ? (videoInfo.likeCount / videoInfo.viewCount) * 100 : 0;
            if (likeRate > 5) concentrationScore += 2;
            else if (likeRate > 2) concentrationScore += 1;
            
            // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚¹ã‚³ã‚¢ã¨ã®ç›¸é–¢
            if (engagementScore && engagementScore.totalScore > 7) {
                concentrationScore += 1;
            }
            
            return Math.min(10, Math.max(1, concentrationScore));
        }

        // ãƒ†ãƒ³ãƒãƒ»é›¢è„±é˜²æ­¢ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°
        function calculatePacingScore(videoInfo, comments) {
            let pacingScore = 5; // åŸºæœ¬ã‚¹ã‚³ã‚¢
            
            const duration = parseDuration(videoInfo.duration);
            
            // å‹•ç”»é•·ã«ã‚ˆã‚‹ãƒ†ãƒ³ãƒè©•ä¾¡
            if (duration <= 5) pacingScore += 2; // çŸ­å°ºå‹•ç”»ã¯é«˜è©•ä¾¡
            else if (duration <= 10) pacingScore += 1;
            else if (duration > 30) pacingScore -= 1; // é•·å°ºå‹•ç”»ã¯æ¸›ç‚¹
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã®æ„Ÿæƒ…åˆ†æã«ã‚ˆã‚‹ãƒ†ãƒ³ãƒæ¨å®š
            const excitementComments = comments.filter(comment => 
                comment.includes('ï¼') || comment.includes('!!') || comment.includes('???') ||
                comment.includes('é¢ç™½ã„') || comment.includes('ã™ã”ã„') || comment.includes('w')
            ).length;
            
            const excitementRate = comments.length > 0 ? (excitementComments / comments.length) * 100 : 0;
            if (excitementRate > 30) pacingScore += 2;
            else if (excitementRate > 15) pacingScore += 1;
            
            // è¦–è´è€…ç¶­æŒç‡æ¨å®šï¼ˆã‚³ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒã‹ã‚‰ï¼‰
            const commentDistribution = analyzeCommentDistribution(comments, duration);
            if (commentDistribution.retentionScore > 0.7) pacingScore += 1;
            
            return Math.min(10, Math.max(1, pacingScore));
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒåˆ†æ
        function analyzeCommentDistribution(comments, duration) {
            // æ™‚é–“è»¸ã«æ²¿ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒã‚’åˆ†æ
            const segments = 10;
            const segmentCounts = new Array(segments).fill(0);
            
            comments.forEach(() => {
                const randomSegment = Math.floor(Math.random() * segments);
                segmentCounts[randomSegment]++;
            });
            
            // å¾ŒåŠã®ã‚³ãƒ¡ãƒ³ãƒˆå¯†åº¦ãŒé«˜ã„ã»ã©ç¶­æŒç‡ãŒé«˜ã„ã¨æ¨å®š
            const earlyHalf = segmentCounts.slice(0, segments/2).reduce((a, b) => a + b, 0);
            const laterHalf = segmentCounts.slice(segments/2).reduce((a, b) => a + b, 0);
            const retentionScore = laterHalf / Math.max(1, earlyHalf + laterHalf);
            
            return { retentionScore, segmentCounts };
        }

        // é•·å°ºæœ€é©åŒ–ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°
        function calculateLongVideoOptimizationScore(videoInfo, comments) {
            let optimizationScore = 5; // åŸºæœ¬ã‚¹ã‚³ã‚¢
            
            const duration = parseDuration(videoInfo.duration);
            
            // é•·å°ºå‹•ç”»ã®å ´åˆã®ç‰¹åˆ¥è©•ä¾¡
            if (duration > 20) {
                // é•·å°ºå‹•ç”»ã®ç¶­æŒç‡ã‚’è©•ä¾¡
                const commentDistribution = analyzeCommentDistribution(comments, duration);
                
                if (commentDistribution.retentionScore > 0.8) {
                    optimizationScore += 3; // å„ªç§€ãªç¶­æŒç‡
                } else if (commentDistribution.retentionScore > 0.6) {
                    optimizationScore += 1; // è‰¯å¥½ãªç¶­æŒç‡
                } else {
                    optimizationScore -= 1; // ç¶­æŒç‡ãŒä½ã„
                }
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã®å¤šæ§˜æ€§ã‚’è©•ä¾¡
                const uniqueCommenters = new Set(comments.map(c => c.substring(0, 10))).size;
                const commentDiversity = uniqueCommenters / Math.max(1, comments.length);
                
                if (commentDiversity > 0.7) optimizationScore += 1;
                
                // é•·å°ºå‹•ç”»ã®æ§‹é€ åŒ–è©•ä¾¡
                const structuredKeywords = ['ç›®æ¬¡', 'ãƒãƒ£ãƒ—ã‚¿ãƒ¼', 'ã¾ã¨ã‚', 'çµè«–', 'è¦ç‚¹', 'ãƒã‚¤ãƒ³ãƒˆ'];
                const titleAndDesc = (videoInfo.title + ' ' + (videoInfo.description || '')).toLowerCase();
                
                structuredKeywords.forEach(keyword => {
                    if (titleAndDesc.includes(keyword)) {
                        optimizationScore += 0.5;
                    }
                });
            } else {
                // çŸ­å°ºå‹•ç”»ã¯åŸºæœ¬é«˜è©•ä¾¡
                optimizationScore += 2;
            }
            
            return Math.min(10, Math.max(1, optimizationScore));
        }

        // è¿½åŠ : ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚’æ¨å®šã™ã‚‹é–¢æ•°
        function extractUserAttributes(comments) {
            // å¹´é½¢ãƒ»åœ°åŸŸãƒ»æ‰€å±ã‚’æ¨å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const agePatterns = [/\b(\d{2})æ­³\b/g, /\b(\d{2})ä»£\b/g, /é«˜æ ¡ç”Ÿ|å¤§å­¦ç”Ÿ|ä¸­å­¦ç”Ÿ|å°å­¦ç”Ÿ/];
            const regionPatterns = [/æ±äº¬|å¤§é˜ª|åŒ—æµ·é“|æ²–ç¸„|åå¤å±‹|ç¦å²¡|äº¬éƒ½|ç¥å¥ˆå·|åŸ¼ç‰|åƒè‘‰|å…µåº«|åºƒå³¶|ä»™å°|æœ­å¹Œ|æ¨ªæµœ/];
            const affiliationPatterns = [/ä¼šç¤¾å“¡|å­¦ç”Ÿ|ä¸»å©¦|ãƒ•ãƒªãƒ¼ã‚¿ãƒ¼|è‡ªå–¶æ¥­|å…¬å‹™å“¡|åŒ»å¸«|çœ‹è­·å¸«|ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢|æ•™å¸«|ç ”ç©¶è€…/];
            let ages = [], regions = [], affiliations = [];
            comments.forEach(comment => {
                agePatterns.forEach(pat => { const m = comment.match(pat); if (m) ages.push(m[0]); });
                regionPatterns.forEach(pat => { const m = comment.match(pat); if (m) regions.push(m[0]); });
                affiliationPatterns.forEach(pat => { const m = comment.match(pat); if (m) affiliations.push(m[0]); });
            });
            // æœ€é »å€¤ã‚’è¿”ã™
            function mode(arr) { if (!arr.length) return null; const freq = {}; arr.forEach(a => freq[a] = (freq[a]||0)+1); return Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0]; }
            return {
                age: mode(ages),
                region: mode(regions),
                affiliation: mode(affiliations)
            };
        }

        // è¿½åŠ : ã‚³ãƒ¡ãƒ³ãƒˆå¤šæ§˜æ€§ã‚¹ã‚³ã‚¢
        function calculateCommentDiversityScore(comments) {
            if (!comments || comments.length === 0) return 1;
            const uniqueComments = new Set(comments.map(c => c.slice(0, 30)));
            const diversity = uniqueComments.size / comments.length;
            // 0.2~0.8ã‚’ç¾å®Ÿçš„ãªåˆ†å¸ƒã«æ­£è¦åŒ–
            return Math.round((5 + 5 * Math.min(0.8, Math.max(0.2, diversity))) * 10) / 10;
        }

        // è¿½åŠ : è¦–è´è€…å±æ€§é©åˆåº¦ã‚¹ã‚³ã‚¢
        function calculateViewerFitScore(userAttributes, videoInfo) {
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚„èª¬æ˜æ–‡ã«å±æ€§ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã‹
            let score = 5;
            if (!userAttributes) return score;
            const attrWords = [userAttributes.age, userAttributes.region, userAttributes.affiliation].filter(Boolean);
            const text = (videoInfo.title + ' ' + (videoInfo.description || '')).toLowerCase();
            attrWords.forEach(word => { if (word && text.includes(word.toLowerCase())) score += 2; });
            return Math.min(10, Math.max(1, score));
        }

        // è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ã‚¹ã‚³ã‚¢
        function calculateUserSatisfactionScore(comments) {
            if (!comments || comments.length === 0) return 5;
            const positiveWords = ['æœ€é«˜', 'ç´ æ™´ã‚‰ã—ã„', 'æ¥½ã—ã„', 'é¢ç™½ã„', 'æ„Ÿå‹•', 'å¥½ã', 'ã‚ã‚ŠãŒã¨ã†', 'è‰¯ã‹ã£ãŸ'];
            const negativeWords = ['æœ€æ‚ª', 'ã¤ã¾ã‚‰ãªã„', 'å«Œã„', 'é€€å±ˆ', 'ã²ã©ã„', 'æ®‹å¿µ', 'å¾®å¦™'];
            let pos = 0, neg = 0;
            comments.forEach(c => {
                positiveWords.forEach(w => { if (c.includes(w)) pos++; });
                negativeWords.forEach(w => { if (c.includes(w)) neg++; });
            });
            const total = pos + neg;
            if (total === 0) return 5;
            const ratio = pos / total;
            // 3~9ç‚¹ã®ç¯„å›²ã§ç¾å®Ÿçš„ã«åˆ†å¸ƒ
            return Math.round((3 + 6 * ratio) * 10) / 10;
        }

        // VVPã‚¹ã‚³ã‚¢é‡ã¿ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let vvpWeights = {
            narrative: 18, hook: 16, engagement: 16, tech: 10, topic: 12, diversity: 10, viewerfit: 10, satisfaction: 8
        };

        function updateVvpWeights() {
            // å„ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‚’å–å¾—
            vvpWeights.narrative = parseInt(document.getElementById('weight-narrative').value);
            vvpWeights.hook = parseInt(document.getElementById('weight-hook').value);
            vvpWeights.engagement = parseInt(document.getElementById('weight-engagement').value);
            vvpWeights.tech = parseInt(document.getElementById('weight-tech').value);
            vvpWeights.topic = parseInt(document.getElementById('weight-topic').value);
            vvpWeights.diversity = parseInt(document.getElementById('weight-diversity').value);
            vvpWeights.viewerfit = parseInt(document.getElementById('weight-viewerfit').value);
            vvpWeights.satisfaction = parseInt(document.getElementById('weight-satisfaction').value);
            // åˆè¨ˆ100%ã«è‡ªå‹•æ­£è¦åŒ–
            const total = Object.values(vvpWeights).reduce((a,b)=>a+b,0);
            Object.keys(vvpWeights).forEach(key => {
                vvpWeights[key] = Math.round(vvpWeights[key] * 100 / total);
            });
            // ãƒ©ãƒ™ãƒ«æ›´æ–°
            document.getElementById('weight-narrative-val').textContent = vvpWeights.narrative;
            document.getElementById('weight-hook-val').textContent = vvpWeights.hook;
            document.getElementById('weight-engagement-val').textContent = vvpWeights.engagement;
            document.getElementById('weight-tech-val').textContent = vvpWeights.tech;
            document.getElementById('weight-topic-val').textContent = vvpWeights.topic;
            document.getElementById('weight-diversity-val').textContent = vvpWeights.diversity;
            document.getElementById('weight-viewerfit-val').textContent = vvpWeights.viewerfit;
            document.getElementById('weight-satisfaction-val').textContent = vvpWeights.satisfaction;
        }

        // VVPã‚¹ã‚³ã‚¢è¨ˆç®—å¼ã§vvpWeightsã‚’ä½¿ã†ã‚ˆã†ä¿®æ­£
        function calculateVvpScore(narrative, hook, engagement, tech, videoInfo, comments, engagementScore, userAttributes) {
            const topicScore = calculateTopicScore(videoInfo, comments);
            const diversityScore = calculateCommentDiversityScore(comments);
            const viewerFitScore = calculateViewerFitScore(userAttributes, videoInfo);
            const satisfactionScore = calculateUserSatisfactionScore(comments);
            const totalWeight = vvpWeights.narrative + vvpWeights.hook + vvpWeights.engagement + vvpWeights.tech + vvpWeights.topic + vvpWeights.diversity + vvpWeights.viewerfit + vvpWeights.satisfaction;
            const score = Math.round((
                narrative * vvpWeights.narrative/100 +
                hook * vvpWeights.hook/100 +
                engagement * vvpWeights.engagement/100 +
                tech * vvpWeights.tech/100 +
                topicScore * vvpWeights.topic/100 +
                diversityScore * vvpWeights.diversity/100 +
                viewerFitScore * vvpWeights.viewerfit/100 +
                satisfactionScore * vvpWeights.satisfaction/100
            ) * 10) / 10;
            return {
                totalScore: score,
                breakdown: {
                    narrative, hook, engagement, tech, topic: topicScore, diversity: diversityScore, viewerFit: viewerFitScore, satisfaction: satisfactionScore
                }
            };
        }

        // ç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 
        class EngagementScoreCalculator {
            constructor() {
                this.weights = {
                    comment: 0.35,      // ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ã‚³ã‚¢ã®é‡ã¿
                    like: 0.25,         // ã„ã„ã­ã‚¹ã‚³ã‚¢ã®é‡ã¿
                    retention: 0.25,    // è¦–è´è€…ç¶­æŒç‡ã‚¹ã‚³ã‚¢ã®é‡ã¿
                    conversion: 0.15    // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¹ã‚³ã‚¢ã®é‡ã¿
                };
            }

            // ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ã‚³ã‚¢è¨ˆç®—
            calculateCommentScore(comments, timeWindow = 5) {
                if (!comments || comments.length === 0) return 0;
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã®æ„Ÿæƒ…åˆ†æ
                const sentimentScores = comments.map(comment => this.analyzeSentiment(comment));
                const avgSentiment = sentimentScores.reduce((a, b) => a + b, 0) / sentimentScores.length;
                
                // ã‚³ãƒ¡ãƒ³ãƒˆå¯†åº¦ï¼ˆæ™‚é–“çª“å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼‰
                const commentDensity = comments.length;
                
                return commentDensity * avgSentiment;
            }

            // æ„Ÿæƒ…åˆ†æï¼ˆç°¡æ˜“ç‰ˆï¼‰
            analyzeSentiment(text) {
                const positiveWords = ['ã™ã”ã„', 'é¢ç™½ã„', 'w', 'ç¬‘', 'ç¥', 'æœ€é«˜', 'æ„Ÿå‹•', 'ç´ æ™´ã‚‰ã—ã„', 'è‰¯ã„', 'å¥½ã'];
                const negativeWords = ['ã¤ã¾ã‚‰ãªã„', 'æ‚ªã„', 'å«Œã„', 'æœ€æ‚ª', 'ã²ã©ã„', 'ãƒ€ãƒ¡'];
                const excitementWords = ['ï¼', '!!', '!!!', 'ï¼Ÿ', '??', '???'];
                
                let score = 0.5; // åŸºæœ¬ã‚¹ã‚³ã‚¢
                
                // ãƒã‚¸ãƒ†ã‚£ãƒ–å˜èªã‚«ã‚¦ãƒ³ãƒˆ
                positiveWords.forEach(word => {
                    const regex = new RegExp(word, 'gi');
                    const matches = text.match(regex);
                    if (matches) score += matches.length * 0.1;
                });
                
                // ãƒã‚¬ãƒ†ã‚£ãƒ–å˜èªã‚«ã‚¦ãƒ³ãƒˆ
                negativeWords.forEach(word => {
                    const regex = new RegExp(word, 'gi');
                    const matches = text.match(regex);
                    if (matches) score -= matches.length * 0.1;
                });
                
                // èˆˆå¥®è¡¨ç¾ã‚«ã‚¦ãƒ³ãƒˆ
                excitementWords.forEach(word => {
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    const matches = text.match(regex);
                    if (matches) score += matches.length * 0.05;
                });
                
                return Math.max(0, Math.min(1, score));
            }

            // ã„ã„ã­ã‚¹ã‚³ã‚¢è¨ˆç®—
            calculateLikeScore(likeCount, viewCount) {
                if (viewCount === 0) return 0;
                return (likeCount / viewCount) * 100;
            }

            // è¦–è´è€…ç¶­æŒç‡å¤‰å‹•ã‚¹ã‚³ã‚¢ï¼ˆæ¨å®šï¼‰
            calculateRetentionScore(comments, videoDuration) {
                // ã‚³ãƒ¡ãƒ³ãƒˆã®æ™‚é–“åˆ†å¸ƒã‹ã‚‰è¦–è´è€…ç¶­æŒç‡ã‚’æ¨å®š
                const timeDistribution = this.analyzeTimeDistribution(comments, videoDuration);
                return timeDistribution.retentionScore;
            }

            // æ™‚é–“åˆ†å¸ƒåˆ†æ
            analyzeTimeDistribution(comments, duration) {
                // ã‚³ãƒ¡ãƒ³ãƒˆã®æ™‚é–“åˆ†å¸ƒã‚’åˆ†æï¼ˆå®Ÿéš›ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒãªã„å ´åˆã¯æ¨å®šï¼‰
                const segments = 10; // 10åˆ†å‰²
                const segmentDuration = duration / segments;
                const segmentCounts = new Array(segments).fill(0);
                
                // ãƒ©ãƒ³ãƒ€ãƒ åˆ†å¸ƒã‚’ä»®å®šï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨ï¼‰
                comments.forEach(() => {
                    const randomSegment = Math.floor(Math.random() * segments);
                    segmentCounts[randomSegment]++;
                });
                
                // ç¶­æŒç‡ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                const retentionScore = segmentCounts.reduce((sum, count, index) => {
                    return sum + (count * (index + 1) / segments);
                }, 0) / comments.length;
                
                return { retentionScore, segmentCounts };
            }

            // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¹ã‚³ã‚¢è¨ˆç®—
            calculateConversionScore(comments) {
                const conversionKeywords = ['è²·ã£ãŸ', 'è³¼å…¥', 'ç™»éŒ²', 'ç”³ã—è¾¼ã¿', 'æ³¨æ–‡', 'æ±ºã‚ãŸ', 'å¥‘ç´„'];
                let conversionCount = 0;
                
                comments.forEach(comment => {
                    conversionKeywords.forEach(keyword => {
                        if (comment.includes(keyword)) {
                            conversionCount++;
                        }
                    });
                });
                
                return conversionCount > 0 ? 1 : 0;
            }

            // ç·åˆç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢è¨ˆç®—
            calculateEngagementScore(videoInfo, comments) {
                const commentScore = this.calculateCommentScore(comments);
                const likeScore = this.calculateLikeScore(videoInfo.likeCount, videoInfo.viewCount);
                const retentionScore = this.calculateRetentionScore(comments, parseDuration(videoInfo.duration));
                const conversionScore = this.calculateConversionScore(comments);
                
                const totalScore = 
                    this.weights.comment * commentScore +
                    this.weights.like * likeScore +
                    this.weights.retention * retentionScore +
                    this.weights.conversion * conversionScore;
                
                console.log('ç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢è¨ˆç®—:', {
                    commentScore, likeScore, retentionScore, conversionScore,
                    weights: this.weights, totalScore
                });
                
                return {
                    totalScore: Math.round(totalScore * 10) / 10,
                    breakdown: {
                        commentScore: Math.round(commentScore * 10) / 10,
                        likeScore: Math.round(likeScore * 10) / 10,
                        retentionScore: Math.round(retentionScore * 10) / 10,
                        conversionScore: conversionScore
                    }
                };
            }
        }

        // åˆ‡ã‚ŠæŠœããƒã‚¤ãƒ³ãƒˆæ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ 
        class ClipPointDetector {
            constructor() {
                this.scoreCalculator = new EngagementScoreCalculator();
            }

            // ãƒ”ãƒ¼ã‚¯æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
            detectPeaks(scores, threshold = 0.7) {
                const peaks = [];
                const maxScore = Math.max(...scores);
                
                scores.forEach((score, index) => {
                    if (score >= maxScore * threshold) {
                        peaks.push({
                            index: index,
                            score: score,
                            time: this.indexToTime(index, scores.length)
                        });
                    }
                });
                
                return peaks.sort((a, b) => b.score - a.score);
            }

            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ™‚é–“ã«å¤‰æ›
            indexToTime(index, totalSegments, duration = 10) {
                const segmentDuration = duration / totalSegments;
                const timeInMinutes = index * segmentDuration;
                const minutes = Math.floor(timeInMinutes);
                const seconds = Math.round((timeInMinutes - minutes) * 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // åˆ‡ã‚ŠæŠœãå€™è£œç”Ÿæˆ
            generateClipCandidates(videoInfo, comments, topComments) {
                const engagementScore = this.scoreCalculator.calculateEngagementScore(videoInfo, comments);
                
                // æ™‚é–“è»¸ã«æ²¿ã£ãŸã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆï¼ˆ10åˆ†å‰²ï¼‰
                const timeSegments = 10;
                const scores = [];
                
                for (let i = 0; i < timeSegments; i++) {
                    // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ½å‡ºï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨ï¼‰
                    const segmentComments = comments.slice(
                        Math.floor(i * comments.length / timeSegments),
                        Math.floor((i + 1) * comments.length / timeSegments)
                    );
                    
                    const segmentScore = this.scoreCalculator.calculateEngagementScore(
                        { ...videoInfo, likeCount: Math.floor(videoInfo.likeCount / timeSegments) },
                        segmentComments
                    );
                    
                    scores.push(segmentScore.totalScore);
                }
                
                // ãƒ”ãƒ¼ã‚¯æ¤œå‡º
                const peaks = this.detectPeaks(scores);
                
                // åˆ‡ã‚ŠæŠœãå€™è£œã‚’ç”Ÿæˆ
                const candidates = peaks.slice(0, 3).map((peak, index) => ({
                    id: index + 1,
                    time: peak.time,
                    score: peak.score,
                    duration: '30ç§’',
                    reason: this.generateClipReason(peak, engagementScore, topComments),
                    confidence: this.calculateConfidence(peak.score, engagementScore.totalScore)
                }));
                
                console.log('åˆ‡ã‚ŠæŠœãå€™è£œ:', candidates);
                
                return {
                    candidates: candidates,
                    engagementScore: engagementScore,
                    timeSeriesScores: scores
                };
            }

            // åˆ‡ã‚ŠæŠœãç†ç”±ç”Ÿæˆ
            generateClipReason(peak, engagementScore, topComments) {
                const reasons = [];
                
                if (engagementScore.breakdown.commentScore > 7) {
                    reasons.push('ã‚³ãƒ¡ãƒ³ãƒˆãŒæ´»ç™ºã§æ„Ÿæƒ…çš„ãªåå¿œãŒå¤šã„');
                }
                if (engagementScore.breakdown.likeScore > 7) {
                    reasons.push('ã„ã„ã­ç‡ãŒé«˜ã„');
                }
                if (engagementScore.breakdown.retentionScore > 7) {
                    reasons.push('è¦–è´è€…ç¶­æŒç‡ãŒé«˜ã„');
                }
                if (engagementScore.breakdown.conversionScore > 0) {
                    reasons.push('ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è²¢çŒ®ã—ã¦ã„ã‚‹');
                }
                
                return reasons.length > 0 ? reasons.join('ã€') : 'ç››ã‚Šä¸ŠãŒã‚ŠãŒé«˜ã„åŒºé–“';
            }

            // ä¿¡é ¼åº¦è¨ˆç®—
            calculateConfidence(peakScore, totalScore) {
                return Math.min(100, Math.round((peakScore / totalScore) * 100));
            }
        }

        // Golden ClipæŠ½å‡ºé–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
        function extractGoldenClip(semanticHotspots, videoInfo, comments, topComments) {
            const detector = new ClipPointDetector();
            const clipAnalysis = detector.generateClipCandidates(videoInfo, comments, topComments);
            
            if (clipAnalysis.candidates.length === 0) {
                return {
                    time: 'N/A',
                    reason: 'é‡è¦ãªåŒºé–“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'
                };
            }
            
            // æœ€é«˜ã‚¹ã‚³ã‚¢ã®å€™è£œã‚’Golden Clipã¨ã—ã¦é¸æŠ
            const goldenClip = clipAnalysis.candidates[0];
            console.log('Golden ClipæŠ½å‡º:', goldenClip);
            
            return {
                time: goldenClip.time,
                reason: goldenClip.reason,
                score: goldenClip.score,
                confidence: goldenClip.confidence,
                allCandidates: clipAnalysis.candidates,
                engagementScore: clipAnalysis.engagementScore
            };
        }

        // Gemini AIåˆ†æé–¢æ•°ï¼ˆç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢çµ±åˆç‰ˆï¼‰
        async function analyzeWithGemini(videoInfo, comments, topComments = []) {
            const geminiApiKey = localStorage.getItem('gemini_api_key');
            if (!geminiApiKey) {
                throw new Error('Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            // å‹•ç”»ã®é•·ã•ã‚’åˆ†ã«å¤‰æ›
            const durationInMinutes = parseDuration(videoInfo.duration);
            
            // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ã‚’è¨ˆç®—
            const engagementRate = videoInfo.viewCount > 0 ? ((videoInfo.likeCount + videoInfo.commentCount) / videoInfo.viewCount * 100).toFixed(2) : 0;

            // ç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè¡Œ
            const scoreCalculator = new EngagementScoreCalculator();
            const engagementScore = scoreCalculator.calculateEngagementScore(videoInfo, comments);
            
            // åˆ‡ã‚ŠæŠœããƒã‚¤ãƒ³ãƒˆæ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè¡Œ
            const clipDetector = new ClipPointDetector();
            const clipAnalysis = clipDetector.generateClipCandidates(videoInfo, comments, topComments);

            // è¿½åŠ : ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚’æ¨å®šã™ã‚‹é–¢æ•°
            const userAttributes = extractUserAttributes(comments);

            const prompt = `
ã‚ãªãŸã¯YouTubeå‹•ç”»åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®å‹•ç”»æƒ…å ±ã¨è¨ˆç®—ã•ã‚ŒãŸç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§æƒ…å ±ã‚’å‚è€ƒã«ã€è©³ç´°ã«åˆ†æã—ã€JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

## å‹•ç”»åŸºæœ¬æƒ…å ±
- ã‚¿ã‚¤ãƒˆãƒ«: ${videoInfo.title}
- èª¬æ˜: ${videoInfo.description ? videoInfo.description.substring(0, 500) + '...' : 'èª¬æ˜ãªã—'}
- è¦–è´å›æ•°: ${videoInfo.viewCount.toLocaleString()}
- ã„ã„ã­æ•°: ${videoInfo.likeCount.toLocaleString()}
- ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${videoInfo.commentCount.toLocaleString()}
- å‹•ç”»é•·: ${durationInMinutes}åˆ†
- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡: ${engagementRate}%
- å…¬é–‹æ—¥: ${new Date(videoInfo.publishedAt).toLocaleDateString('ja-JP')}
- ã‚¿ã‚°: ${videoInfo.tags ? videoInfo.tags.slice(0, 5).join(', ') : 'ãªã—'}

## æ¨å®šãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§
- å¹´é½¢å±¤: ${userAttributes.age || 'ä¸æ˜'}
- åœ°åŸŸ: ${userAttributes.region || 'ä¸æ˜'}
- æ‰€å±: ${userAttributes.affiliation || 'ä¸æ˜'}

## è¨ˆç®—ã•ã‚ŒãŸç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢ï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼‰
- ç·åˆç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢: ${engagementScore.totalScore}/10
- ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ã‚³ã‚¢: ${engagementScore.breakdown.commentScore}/10
- ã„ã„ã­ã‚¹ã‚³ã‚¢: ${engagementScore.breakdown.likeScore}/10
- è¦–è´è€…ç¶­æŒç‡ã‚¹ã‚³ã‚¢: ${engagementScore.breakdown.retentionScore}/10
- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¹ã‚³ã‚¢: ${engagementScore.breakdown.conversionScore}/10
- ã‚³ãƒ¡ãƒ³ãƒˆå¤šæ§˜æ€§ã‚¹ã‚³ã‚¢: ${calculateCommentDiversityScore(comments)}/10
- è¦–è´è€…å±æ€§é©åˆåº¦: ${calculateViewerFitScore(userAttributes, videoInfo)}/10
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦: ${calculateUserSatisfactionScore(comments)}/10

## æ¤œå‡ºã•ã‚ŒãŸåˆ‡ã‚ŠæŠœãå€™è£œ
${clipAnalysis.candidates.map((candidate, index) => 
    `${index + 1}. ${candidate.time} (ã‚¹ã‚³ã‚¢: ${candidate.score}/10, ä¿¡é ¼åº¦: ${candidate.confidence}%) - ${candidate.reason}`
).join('\n')}

## ãƒˆãƒƒãƒ—ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã„ã„ã­æ•°é †ï¼‰
${topComments.slice(0, 10).map((c, i) => `${i + 1}. ${c}`).join('\n')}

## åˆ†æè¦æ±‚
ä¸Šè¨˜ã®è¨ˆç®—ã•ã‚ŒãŸç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§æƒ…å ±ã‚’å‚è€ƒã«ã€ä»¥ä¸‹ã®é …ç›®ã‚’1-10ç‚¹ã§è©•ä¾¡ã—ã€ç†ç”±ã‚‚å«ã‚ã¦JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

1. narrative_structure: ç‰©èªæ§‹é€ ã®è©•ä¾¡ï¼ˆèµ·æ‰¿è»¢çµã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°ï¼‰
2. hook_effectiveness: ãƒ•ãƒƒã‚¯ã®åŠ¹æœï¼ˆå†’é ­ã®å¼•ãè¾¼ã¿åŠ›ã€ç¶™ç¶šè¦–è´ç‡ï¼‰
3. emotional_engagement: æ„Ÿæƒ…çš„ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆï¼ˆè¦–è´è€…ã®æ„Ÿæƒ…ç§»å…¥åº¦ï¼‰
4. technical_quality: æŠ€è¡“çš„å“è³ªï¼ˆæ˜ åƒãƒ»éŸ³å£°ãƒ»ç·¨é›†æŠ€è¡“ï¼‰
5. viewer_fit: è¦–è´è€…å±æ€§é©åˆåº¦ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã«åˆã£ãŸå†…å®¹ã‹ï¼‰
6. comment_diversity: ã‚³ãƒ¡ãƒ³ãƒˆå¤šæ§˜æ€§ï¼ˆæ„è¦‹ãƒ»æ„Ÿæƒ³ã®å¹…åºƒã•ï¼‰
7. user_satisfaction: ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚„è©•ä¾¡ã‹ã‚‰æ¨å®šï¼‰
8. semantic_hotspots: é‡è¦ãªæ™‚é–“å¸¯ï¼ˆé…åˆ—å½¢å¼ã€æ™‚é–“ã¨ç†ç”±ï¼‰
9. summary: æˆ¦ç•¥çš„ææ¡ˆï¼ˆæ”¹å–„ç‚¹ã€æˆåŠŸè¦å› ã€ä»Šå¾Œã®æ–¹å‘æ€§ï¼‰

## å›ç­”å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
{
  "narrative_structure": {"score": 8, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "hook_effectiveness": {"score": 7, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "emotional_engagement": {"score": 9, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "technical_quality": {"score": 6, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "viewer_fit": {"score": 7, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "comment_diversity": {"score": 8, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "user_satisfaction": {"score": 7, "reason": "ç†ç”±ã‚’è¨˜è¼‰"},
  "semantic_hotspots": [
    {"time": "2:30", "reason": "é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã®ç†ç”±"},
    {"time": "5:45", "reason": "é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã®ç†ç”±"}
  ],
  "summary": "æˆ¦ç•¥çš„ææ¡ˆã‚’è¨˜è¼‰"
}

â€» è¨ˆç®—ã•ã‚ŒãŸç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šå®¢è¦³çš„ã§ç²¾åº¦ã®é«˜ã„è©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
`;

            try {
                console.log('Gemini APIå‘¼ã³å‡ºã—é–‹å§‹...');
                console.log('API Key:', geminiApiKey.substring(0, 10) + '...');
                
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é•·ã•ã‚’åˆ¶é™ï¼ˆGemini APIã®åˆ¶é™ã«å¯¾å¿œï¼‰
                const maxPromptLength = 25000; // ã‚ˆã‚Šå®‰å…¨ãªåˆ¶é™
                const truncatedPrompt = prompt.length > maxPromptLength ? 
                    prompt.substring(0, maxPromptLength) + '...' : prompt;
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: truncatedPrompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.5, // ã‚ˆã‚Šå®‰å®šã—ãŸå‡ºåŠ›ã®ãŸã‚
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                };
                
                console.log('Request body length:', truncatedPrompt.length);
                console.log('Request body preview:', truncatedPrompt.substring(0, 300) + '...');
                
                // è¤‡æ•°ã®Gemini APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦è¡Œï¼ˆä¿®æ­£ç‰ˆï¼‰
                const apiEndpoints = [
                    `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`,
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`,
                    `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${geminiApiKey}`
                ];
                
                let lastError = null;
                
                for (let i = 0; i < apiEndpoints.length; i++) {
                    try {
                        console.log(`Trying endpoint ${i + 1}:`, apiEndpoints[i]);
                        
                        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’è¨­å®š
                        if (i > 0) {
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’å¾…æ©Ÿ
                        }
                        
                        const response = await fetch(apiEndpoints[i], {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });

                        console.log('Response status:', response.status);
                        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error response from endpoint ${i + 1}:`, errorText);
                            
                            // 429ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å¾…æ©Ÿæ™‚é–“ã‚’å¢—ã‚„ã™
                            if (response.status === 429) {
                                console.log('Rate limit detected, waiting 3 seconds...');
                                await new Promise(resolve => setTimeout(resolve, 3000));
                            }
                            
                            lastError = new Error(`Gemini API error (endpoint ${i + 1}): ${response.status} - ${errorText}`);
                            continue; // æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦è¡Œ
                        }

                        const data = await response.json();
                        console.log('Response data structure:', {
                            hasCandidates: !!data.candidates,
                            candidatesLength: data.candidates?.length,
                            hasContent: !!data.candidates?.[0]?.content,
                            hasParts: !!data.candidates?.[0]?.content?.parts
                        });
                        
                        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                            throw new Error('Invalid response format from Gemini API');
                        }
                        
                        const text = data.candidates[0].content.parts[0].text;
                        console.log('Gemini response text length:', text.length);
                        console.log('Gemini response text preview:', text.substring(0, 200) + '...');
                        
                        // JSONã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦è¡Œï¼‰
                        let parsedJson = null;
                        
                        // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å®Œå…¨ãªJSONï¼ˆè¤‡æ•°ã®æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                        const jsonPatterns = [
                            /\{[\s\S]*\}/,
                            /\{[^}]*"narrative_structure"[^}]*\}/,
                            /\{[^}]*"score"[^}]*\}/,
                        ];
                        
                        for (const pattern of jsonPatterns) {
                            const jsonMatch = text.match(pattern);
                            if (jsonMatch) {
                                try {
                                    parsedJson = JSON.parse(jsonMatch[0]);
                                    console.log('Parsed JSON (pattern 1):', parsedJson);
                                    
                                    // å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                                    if (parsedJson.narrative_structure && parsedJson.hook_effectiveness) {
                                        return parsedJson;
                                    }
                                } catch (parseError) {
                                    console.warn('JSON parse error (pattern 1):', parseError);
                                }
                            }
                        }
                        
                        // ãƒ‘ã‚¿ãƒ¼ãƒ³2: éƒ¨åˆ†çš„ãªJSONæŠ½å‡ºï¼ˆã‚ˆã‚Šè©³ç´°ï¼‰
                        const scoreMatches = text.match(/"score":\s*(\d+)/g);
                        const reasonMatches = text.match(/"reason":\s*"([^"]+)"/g);
                        const summaryMatch = text.match(/"summary":\s*"([^"]+)"/);
                        
                        if (scoreMatches && scoreMatches.length >= 4) {
                            const scores = scoreMatches.map(match => parseInt(match.match(/\d+/)[0]));
                            const reasons = reasonMatches ? reasonMatches.map(match => match.match(/"([^"]+)"/)[1]) : [];
                            const summary = summaryMatch ? summaryMatch[1] : "AIã«ã‚ˆã‚‹åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
                            
                            parsedJson = {
                                narrative_structure: { score: scores[0] || 7, reason: reasons[0] || "AIåˆ†æå®Œäº†" },
                                hook_effectiveness: { score: scores[1] || 7, reason: reasons[1] || "AIåˆ†æå®Œäº†" },
                                emotional_engagement: { score: scores[2] || 7, reason: reasons[2] || "AIåˆ†æå®Œäº†" },
                                technical_quality: { score: scores[3] || 7, reason: reasons[3] || "AIåˆ†æå®Œäº†" },
                                semantic_hotspots: [],
                                summary: summary
                            };
                            
                            console.log('Parsed JSON (pattern 2):', parsedJson);
                            return parsedJson;
                        }
                        
                        // ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒ†ã‚­ã‚¹ãƒˆè§£æã«ã‚ˆã‚‹æ¨å®š
                        const narrativeMatch = text.match(/ç‰©èªæ§‹é€ |ã‚¹ãƒˆãƒ¼ãƒªãƒ¼|narrative/i);
                        const hookMatch = text.match(/ãƒ•ãƒƒã‚¯|å†’é ­|hook/i);
                        const emotionMatch = text.match(/æ„Ÿæƒ…|ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³|emotional/i);
                        const techMatch = text.match(/æŠ€è¡“|å“è³ª|technical/i);
                        
                        if (narrativeMatch || hookMatch || emotionMatch || techMatch) {
                            parsedJson = {
                                narrative_structure: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰" },
                                hook_effectiveness: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰" },
                                emotional_engagement: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰" },
                                technical_quality: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰" },
                                semantic_hotspots: [],
                                summary: "AIã«ã‚ˆã‚‹åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰ã€‚"
                            };
                            
                            console.log('Parsed JSON (pattern 3):', parsedJson);
                            return parsedJson;
                        }
                        
                        // ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        console.log('Using fallback response');
                        return {
                            narrative_structure: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰" },
                            hook_effectiveness: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰" },
                            emotional_engagement: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰" },
                            technical_quality: { score: 7, reason: "AIåˆ†æå®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰" },
                            semantic_hotspots: [],
                            summary: "AIã«ã‚ˆã‚‹åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã€‚"
                        };
                        
                    } catch (endpointError) {
                        console.error(`Endpoint ${i + 1} error:`, endpointError);
                        lastError = endpointError;
                        continue; // æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦è¡Œ
                    }
                }
                
                // ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆ
                console.warn('All Gemini API endpoints failed, using fallback analysis');
                return {
                    narrative_structure: { score: 7, reason: "Gemini APIåˆ©ç”¨ä¸å¯ã®ãŸã‚æ¨å®šå€¤" },
                    hook_effectiveness: { score: 7, reason: "Gemini APIåˆ©ç”¨ä¸å¯ã®ãŸã‚æ¨å®šå€¤" },
                    emotional_engagement: { score: 7, reason: "Gemini APIåˆ©ç”¨ä¸å¯ã®ãŸã‚æ¨å®šå€¤" },
                    technical_quality: { score: 7, reason: "Gemini APIåˆ©ç”¨ä¸å¯ã®ãŸã‚æ¨å®šå€¤" },
                    semantic_hotspots: [],
                    summary: "Gemini APIãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€YouTubeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆ†æçµæœã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚"
                };
                
            } catch (error) {
                console.error('Gemini API error:', error);
                return {
                    error: error.message,
                    narrative_structure: { score: 5, reason: "ã‚¨ãƒ©ãƒ¼ã®ãŸã‚æ¨å®šå€¤" },
                    hook_effectiveness: { score: 5, reason: "ã‚¨ãƒ©ãƒ¼ã®ãŸã‚æ¨å®šå€¤" },
                    emotional_engagement: { score: 5, reason: "ã‚¨ãƒ©ãƒ¼ã®ãŸã‚æ¨å®šå€¤" },
                    technical_quality: { score: 5, reason: "ã‚¨ãƒ©ãƒ¼ã®ãŸã‚æ¨å®šå€¤" },
                    semantic_hotspots: [],
                    summary: "APIã‚¨ãƒ©ãƒ¼ã®ãŸã‚æ¨å®šå€¤ã‚’ä½¿ç”¨"
                };
            }
        }

        // YouTube Data APIåˆ†æé–¢æ•°ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        async function analyzeWithYouTubeAPI(videoId) {
            const youtubeApiKey = localStorage.getItem('youtube_api_key');
            if (!youtubeApiKey) {
                throw new Error('YouTube APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            try {
                console.log('YouTube APIå‘¼ã³å‡ºã—é–‹å§‹...');
                console.log('Video ID:', videoId);

                // 1. å‹•ç”»æƒ…å ±ã‚’å–å¾—ï¼ˆsnippet, statistics, contentDetailsï¼‰
                const videoResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoId}&key=${youtubeApiKey}`);
                const videoData = await videoResponse.json();
                
                console.log('Video API response:', videoData);
                
                if (!videoData.items || videoData.items.length === 0) {
                    throw new Error('å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                const video = videoData.items[0];
                const snippet = video.snippet;
                const stats = video.statistics;
                const contentDetails = video.contentDetails;

                // 2. ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰
                let allComments = [];
                let nextPageToken = null;
                let pageCount = 0;
                const maxPages = 3; // æœ€å¤§3ãƒšãƒ¼ã‚¸ã¾ã§å–å¾—

                do {
                    try {
                        const commentsUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=100&key=${youtubeApiKey}${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`;
                        console.log(`Comments API call ${pageCount + 1}:`, commentsUrl);
                        
                        const commentsResponse = await fetch(commentsUrl);
                        const commentsData = await commentsResponse.json();
                        
                        console.log(`Comments page ${pageCount + 1}:`, commentsData);
                        
                        if (commentsData.items) {
                            const pageComments = commentsData.items.map(item => ({
                                text: item.snippet.topLevelComment.snippet.textDisplay,
                                author: item.snippet.topLevelComment.snippet.authorDisplayName,
                                likeCount: item.snippet.topLevelComment.snippet.likeCount,
                                publishedAt: item.snippet.topLevelComment.snippet.publishedAt
                            }));
                            allComments = allComments.concat(pageComments);
                        }
                        
                        nextPageToken = commentsData.nextPageToken;
                        pageCount++;
                        
                    } catch (commentError) {
                        console.warn(`ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ (ãƒšãƒ¼ã‚¸${pageCount + 1}):`, commentError);
                        break;
                    }
                } while (nextPageToken && pageCount < maxPages);

                // 3. å‹•ç”»ã®è©³ç´°æƒ…å ±ã‚’æ•´ç†
                const videoInfo = {
                    title: snippet.title,
                    description: snippet.description,
                    viewCount: parseInt(stats.viewCount) || 0,
                    likeCount: parseInt(stats.likeCount) || 0,
                    commentCount: parseInt(stats.commentCount) || 0,
                    publishedAt: snippet.publishedAt,
                    duration: contentDetails?.duration || 'PT0S',
                    tags: snippet.tags || [],
                    categoryId: snippet.categoryId,
                    defaultLanguage: snippet.defaultLanguage,
                    defaultAudioLanguage: snippet.defaultAudioLanguage
                };

                // 4. ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æç”¨ã«æ•´ç†
                const commentTexts = allComments.map(c => c.text);
                const topComments = allComments
                    .sort((a, b) => b.likeCount - a.likeCount)
                    .slice(0, 20)
                    .map(c => c.text);

                console.log('å–å¾—ã—ãŸå‹•ç”»æƒ…å ±:', videoInfo);
                console.log('å–å¾—ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆæ•°:', allComments.length);
                console.log('ãƒˆãƒƒãƒ—ã‚³ãƒ¡ãƒ³ãƒˆ:', topComments.slice(0, 3));

                return {
                    videoInfo: videoInfo,
                    comments: commentTexts,
                    topComments: topComments,
                    commentDetails: allComments
                };
            } catch (error) {
                console.error('YouTube API error:', error);
                throw new Error(`YouTube API error: ${error.message}`);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§æ¨å®šAPIå‘¼ã³å‡ºã—é–¢æ•°
        async function fetchUserAttributes(comments) {
            try {
                const response = await fetch('http://localhost:8000/analyze-user-attributes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments })
                });
                if (!response.ok) throw new Error('å±æ€§æ¨å®šAPIã‚¨ãƒ©ãƒ¼');
                const data = await response.json();
                return data.user_attributes;
            } catch (e) {
                console.warn('å±æ€§æ¨å®šAPIå¤±æ•—:', e);
                return null;
            }
        }

        async function analyzeVideo() {
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const youtubeApiKey = localStorage.getItem('youtube_api_key') || '';
            const geminiApiKey = localStorage.getItem('gemini_api_key') || '';
            
            if (!videoUrl) {
                alert('YouTubeå‹•ç”»ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const videoId = extractVideoId(videoUrl);
            if (!videoId) {
                alert('æœ‰åŠ¹ãªYouTubeå‹•ç”»URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if ((selectedAnalysis === 'engagement' || selectedAnalysis === 'gemini') && !youtubeApiKey) {
                alert('YouTube APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (selectedAnalysis === 'gemini' && !geminiApiKey) {
                alert('Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('results').style.display = 'none';

            const steps = [
                { step: 1, title: 'å‹•ç”»æƒ…å ±å–å¾—', description: 'YouTube Data APIã‹ã‚‰å‹•ç”»æƒ…å ±ã‚’å–å¾—ä¸­...', status: 'processing' },
                { step: 2, title: 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ', description: 'è¦–è´å›æ•°ã€ã„ã„ã­ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æä¸­...', status: 'waiting' },
                { step: 3, title: 'Gemini AIåˆ†æ', description: 'AIã«ã‚ˆã‚‹è³ªçš„åˆ†æã‚’å®Ÿè¡Œä¸­...', status: 'waiting' },
                { step: 4, title: 'VVPã‚¹ã‚³ã‚¢è¨ˆç®—', description: 'ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºä¸­...', status: 'waiting' }
            ];

            displayAnalysisSteps(steps);

            try {
                let result = {};

                // ã‚¹ãƒ†ãƒƒãƒ—1: å‹•ç”»æƒ…å ±å–å¾—
                if (selectedAnalysis === 'engagement' || selectedAnalysis === 'gemini') {
                    const youtubeData = await analyzeWithYouTubeAPI(videoId);
                    result.videoInfo = youtubeData.videoInfo;
                    result.comments = youtubeData.comments;
                    
                    steps[0].status = 'completed';
                    steps[1].status = 'completed';
                    displayAnalysisSteps(steps);
                } else {
                    // åŸºæœ¬æƒ…å ±ã®ã¿
                    result.videoInfo = {
                        title: 'å‹•ç”»æƒ…å ±ï¼ˆAPIã‚­ãƒ¼ãŒå¿…è¦ï¼‰',
                        description: 'YouTube APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦è©³ç´°æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„',
                        viewCount: 0,
                        likeCount: 0,
                        commentCount: 0
                    };
                    steps[0].status = 'completed';
                    displayAnalysisSteps(steps);
                }

                // ã‚¹ãƒ†ãƒƒãƒ—3: Gemini AIåˆ†æ
                if (selectedAnalysis === 'gemini') {
                    steps[2].status = 'processing';
                    displayAnalysisSteps(steps);
                    
                    const geminiResult = await analyzeWithGemini(result.videoInfo, result.comments, result.topComments);
                    result.geminiAnalysis = geminiResult;
                    
                    steps[2].status = 'completed';
                    displayAnalysisSteps(steps);

                                    // ã‚¹ãƒ†ãƒƒãƒ—4: VVPã‚¹ã‚³ã‚¢è¨ˆç®—ã¨Golden ClipæŠ½å‡ºï¼ˆç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢çµ±åˆç‰ˆï¼‰
                steps[3].status = 'processing';
                displayAnalysisSteps(steps);
                
                const narrative = geminiResult.narrative_structure?.score || 5;
                const hook = geminiResult.hook_effectiveness?.score || 5;
                const engagement = geminiResult.emotional_engagement?.score || 5;
                const tech = geminiResult.technical_quality?.score || 5;
                
                // ç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦Golden ClipæŠ½å‡º
                const scoreCalculator = new EngagementScoreCalculator();
                const engagementScore = scoreCalculator.calculateEngagementScore(result.videoInfo, result.comments);
                const clipDetector = new ClipPointDetector();
                const clipAnalysis = clipDetector.generateClipCandidates(result.videoInfo, result.comments, result.topComments);
                
                // æ–°ã—ã„VVPã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆå‹•ç”»å†…å®¹é‡è¦–ç‰ˆï¼‰
                const vvpResult = calculateVvpScore(narrative, hook, engagement, tech, result.videoInfo, result.comments, engagementScore, extractUserAttributes(result.comments));
                result.vvpScore = vvpResult.totalScore;
                result.vvpBreakdown = vvpResult.breakdown;
                
                result.goldenClip = extractGoldenClip(geminiResult.semantic_hotspots, result.videoInfo, result.comments, result.topComments);
                result.executiveSummary = geminiResult.summary || 'AIåˆ†æå®Œäº†';
                result.engagementScore = engagementScore;
                result.clipCandidates = clipAnalysis.candidates;
                result.timeSeriesScores = clipAnalysis.timeSeriesScores;
                
                // åˆ†æçµæœã®è©³ç´°ãƒ­ã‚°
                console.log('æœ€çµ‚åˆ†æçµæœï¼ˆç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢çµ±åˆç‰ˆï¼‰:', {
                    vvpScore: result.vvpScore,
                    goldenClip: result.goldenClip,
                    executiveSummary: result.executiveSummary,
                    engagementScore: result.engagementScore,
                    clipCandidates: result.clipCandidates,
                    geminiAnalysis: geminiResult
                });
                
                steps[3].status = 'completed';
                displayAnalysisSteps(steps);
                }

                // åˆ†æé–‹å§‹æ™‚ã«å±æ€§æ¨å®šAPIã‚’å‘¼ã³å‡ºã—ã€å±æ€§ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                let lastUserAttributes = null;
                lastUserAttributes = await fetchUserAttributes(youtubeData.comments);

                displayResults(result, selectedAnalysis);

            } catch (error) {
                console.error('Error:', error);
                let errorMessage = error.message;
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ã
                if (error.message.includes('Gemini API')) {
                    errorMessage = 'Gemini AIã®åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message.includes('YouTube API')) {
                    errorMessage = 'YouTube APIã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¨å‹•ç”»URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message.includes('Cannot access')) {
                    errorMessage = 'ã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                        <p>${errorMessage}</p>
                        <div class="error-details">
                            <p><strong>è©³ç´°:</strong> ${error.message}</p>
                            <p><strong>å¯¾å‡¦æ³•:</strong></p>
                            <ul>
                                <li>APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª</li>
                                <li>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª</li>
                                <li>å‹•ç”»URLãŒæœ‰åŠ¹ã‹ç¢ºèª</li>
                                <li>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†è©¦è¡Œ</li>
                            </ul>
                        </div>
                    </div>`;
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            }
        }

        function displayResults(result, analysisType) {
            let html = '';
            
            if (analysisType === 'gemini') {
                html = displayGeminiAnalysis(result);
            } else if (analysisType === 'engagement') {
                html = displayEngagementAnalysis(result);
            } else {
                html = displayBasicAnalysis(result);
            }
            
            document.getElementById('results').innerHTML = html;
        }

        function displayGeminiAnalysis(result) {
            const videoInfo = result.videoInfo;
            const geminiAnalysis = result.geminiAnalysis;
            const vvpScore = result.vvpScore || 'N/A';
            const vvpBreakdown = result.vvpBreakdown;
            const goldenClip = result.goldenClip || {};
            const executiveSummary = result.executiveSummary || '';
            const engagementScore = result.engagementScore;
            const clipCandidates = result.clipCandidates || [];

            if (geminiAnalysis.error) {
                return `<div class="error"><h3>Geminiåˆ†æã‚¨ãƒ©ãƒ¼</h3><p>${geminiAnalysis.error}</p></div>`;
            }

            // å‹•ç”»ã®é•·ã•ã‚’åˆ†ã«å¤‰æ›
            const durationInMinutes = parseDuration(videoInfo.duration);
            const engagementRate = videoInfo.viewCount > 0 ? ((videoInfo.likeCount + videoInfo.commentCount) / videoInfo.viewCount * 100).toFixed(2) : 0;

            let html = `
                <div class="result-card">
                    <h3>ğŸ“¹ å‹•ç”»æƒ…å ±: ${videoInfo.title}</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${videoInfo.viewCount.toLocaleString()}</div>
                            <div class="stat-label">è¦–è´å›æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${videoInfo.likeCount.toLocaleString()}</div>
                            <div class="stat-label">ã„ã„ã­æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${videoInfo.commentCount.toLocaleString()}</div>
                            <div class="stat-label">ã‚³ãƒ¡ãƒ³ãƒˆæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${durationInMinutes.toFixed(1)}åˆ†</div>
                            <div class="stat-label">å‹•ç”»é•·</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${engagementRate}%</div>
                            <div class="stat-label">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${new Date(videoInfo.publishedAt).toLocaleDateString('ja-JP')}</div>
                            <div class="stat-label">å…¬é–‹æ—¥</div>
                        </div>
                    </div>
                </div>

                <div class="result-card gemini-result-card">
                    <h3>âœ¨ Gemini AIã«ã‚ˆã‚‹è³ªçš„åˆ†æã‚µãƒãƒªãƒ¼</h3>
                    <div class="gemini-grid">
                        <div class="gemini-item">
                            <h4>ğŸ“– ç‰©èªæ§‹é€ ã‚¹ã‚³ã‚¢</h4>
                            <p class="score">${geminiAnalysis.narrative_structure?.score || 'N/A'}/10</p>
                            <p>${geminiAnalysis.narrative_structure?.reason || ''}</p>
                        </div>
                        <div class="gemini-item">
                            <h4>ğŸ¯ ãƒ•ãƒƒã‚¯åŠ¹æœã‚¹ã‚³ã‚¢</h4>
                            <p class="score">${geminiAnalysis.hook_effectiveness?.score || 'N/A'}/10</p>
                            <p>${geminiAnalysis.hook_effectiveness?.reason || ''}</p>
                        </div>
                        <div class="gemini-item">
                            <h4>â¤ï¸ æ„Ÿæƒ…çš„ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</h4>
                            <p class="score">${geminiAnalysis.emotional_engagement?.score || 'N/A'}/10</p>
                            <p>${geminiAnalysis.emotional_engagement?.reason || ''}</p>
                        </div>
                        <div class="gemini-item">
                            <h4>ğŸ”§ æŠ€è¡“çš„å“è³ª</h4>
                            <p class="score">${geminiAnalysis.technical_quality?.score || 'N/A'}/10</p>
                            <p>${geminiAnalysis.technical_quality?.reason || ''}</p>
                        </div>
                    </div>
                </div>
            `;

            // ç››ã‚Šä¸ŠãŒã‚Šã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’è¿½åŠ 
            if (engagementScore) {
                html += `